---
alias: Designing Microsoft Azure Infrastructure Solutions, Azure Solutions Architect Expert
tags:
- published
- index/27.14
---

Skills challenge: [Challenge](https://learn.microsoft.com/en-us/training/challenges?id=71858d04-7069-436b-860c-a432f5bf3540)

Personal bookmark: [Collections - cloudskillschallenge | Microsoft Learn](https://learn.microsoft.com/en-us/users/cloudskillschallenge/collections/ykznh4nr46px?WT.mc_id=cloudskillschallenge_71858d04-7069-436b-860c-a432f5bf3540)

Feedbacks: 
- [AZ-305 Exam Completed with Feedback and Preparation Guidance (ourcloudnetwork.com)](https://ourcloudnetwork.com/az305-exam/)
- [I took the New AZ-305 Azure Architect beta exam, here is my feedback! : microsoft (reddit.com)](https://www.reddit.com/r/microsoft/comments/r3f90y/i_took_the_new_az305_azure_architect_beta_exam/)

Useful Resources:
- [Azure Intersite Connectivity and Azure Network Traffic Management (k21academy.com)](https://k21academy.com/microsoft-azure/admin/recap-day-3-3/)

---


# Describe core Azure architectural components

## Management Level

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-architecture-fundamentals/media/hierarchy-372fef74.png)

- Management groups: manage access, policy and compliance for multiple subscriptions. All Subscriptions underneath will inherit the conditions from management group
- Subscriptions: used to manage costs and separation of resources, assign limits or quotas
- Resource groups: resources are combined into resource groups and acts as logical container where resources are deployed and managed.
- Resources: instances of the services like VMs, storage, SQL database etc

## Azure regions, availability zones and region pairs

### Regions

Region - geographical area on planet that contains at least one but potentially multiple datacenters nearby and networked together with low latency network. 

> It is important to know that some services and VM features are only available in certain regions. 

Here's a virtual tour of Microsoft Datacenters: [Azure global infrastructure experience](https://datacenters.microsoft.com/globe/explore)

Regions make it easier to keep your services closer to your users, provide better scalability and redundancy, and preserve data residency. 


#### Special Azure Regions

> For legal and compliance purposes

- US DoD Central, US Gov Virginia, US Gov Iowa and more
- China East, China North, and more

### Availability zones

- Physically separate datacenter within the same azure region.
- Ensuring data and services redundancy to protect them from failure. This is a duplicate hardware environment that makes apps and services highly available.
- Each availability zone is setup with isolation boundary, independent power, cooling and networking. If one zone goes down, the other continues working. 

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-architecture-fundamentals/media/availability-zones-5c3c490c.png)

> Always review the services and regions with availability zones (see https://learn.microsoft.com/en-us/azure/reliability/availability-zones-service-support)

- [x] NEXT: [Azure regions, availability zones, and region pairs - Training | Microsoft Learn](https://learn.microsoft.com/en-us/training/modules/azure-architecture-fundamentals/regions-availability-zones) Unit 3 of 7 ✅ 2023-05-31

### Region pair

- same region within same geography at least 300 miles away from each other
- helps prevent interruptions due to catastrophic events 

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-architecture-fundamentals/media/region-pairs-d9eb9728.png)


## Azure resources and Azure Resource Manager

- Resource - manageable item like VM, storage accounts, web apps, databases, virtual networks etc
- Resource group - 

### Azure resource groups

- logical container for resources
- 1:1 - a resource can only be a member of a single resource group
- resources can be moved from one group to another but some will have specific limitations or requirements to move
- cannot be nested
- all resources will need a resource group before it can be deployed

### logical grouping

place similar usage, type or location in a resource group for logical grouping

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-architecture-fundamentals/media/resource-group-461ef7f2.png)

#### life cycle

- deleting a resource group deletes all resources inside it
- organizing resources by life cycle is useful for nonprod environments 

#### authorization

- can use RBAC 

### Azure Resource Manager

- deployment and management service for azure, allows you to create, update and delete resources
- management features - control, locks, tags
- can manage infra using templates than scripts as Resource Manager template is just a JSON file
- can deploy, manage and monitor all resources as a group rather than individual resources
- define dependencies as it can be deployed in order
- access control as RBAC is integrated natively
- tags to logically organize resources

## Azure subscriptions and management groups

### Azure subscriptions

- provides authenticated and authorized access to Azure products and services, allows provisioning 
- logical unit of Azure services that links to an Azure account (account in AAD)

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-architecture-fundamentals/media/subscriptions-afe063a7.png)

- Billing boundary - can create multiple subscriptions for different billing requirements as the billing reports and invoices per subscriptions are different (ie if Finance wants to pay for their own subs, and Devs would pay for theirs, it makes sense to create separate subscriptions for them)
- Access control boundary - applies access-management policies at subscription level.

You might want to create separate subscriptions for resource or billing management purposes. For different environments (dev, prod etc), org structure (limit team to low cost resources or give another full range), billing (different billing for dev or prod), or subscription limits (if you want to set hard limits)

#### customize billing

- it is possible to setup multiple invoices within the same billing account by creating **billing profiles** as it has its own monthly invoice and payment method. 

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-architecture-fundamentals/media/billing-structure-overview-2c81a8ad.png)


### Azure management groups

- level of scope above subscriptions
- apply governance condition to management groups - it automatically inherits the conditions applied to the management group. 
- gives enterprise grade management at a large scale no matter what type of subscription (ex: all subscription should trust the same Azure AD tenant) or limit the regions available for VM creation. 

#### hierarchy

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-architecture-fundamentals/media/management-groups-and-subscriptions-bba71896.png)

- ex: limit vm locations to a specific region in a specific group - this will inherit unto any EA subscriptions that are descendants of that management group and will apply to all VMs underneath. This policy cant be altered by the resource or even subscription owner

> [!IMPORTANT]
> - 10,000 management groups can be supported in a single directory
> - management group tree can only support six levels of depth (doesn't include root or subscription level)
> - each management group and subscription can only support one parent but can have many children
> - all subscriptions and management groups are within a single hierarchy in each directory


# Build a cloud governance strategy on Azure

## Control access to cloud resources using RBAC

- RBAC is applied to a scope(resource or set of resources like management group, single subscription, resource group, single resource)

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/build-cloud-governance-strategy-azure/media/4-role-scope-0223bfae.png)


- **Owner** - (if assigned to management group) can manage everything in all subscription within the management group
- **Reader** - (if assigned to a subscription) can view every resource in the subscription
- **Contributor** - (if assigned to an application at the resource group scope) can manage resources of all types in that resource group but not other resource groups in the subscription

**RBAC** is enforced on any resource that passes through Azure Resource Manager (which is accessible via Azure Portal, Azure Cloud Shell, Azure PowerShell and Azure CLI). It doesn't enforce access permissions at the application or data level. Application security should be handled through the app. It follows the *allow model* which grants permissions.

### RBAC application

- can be applied to an individual person or group
- special identity types like service principal or managed identities

### Manage RBAC Permissions

- manageable through **Access control (IAM)** pane

![Pasted image 20230531080423](https://i.imgur.com/vlsVXxV.png)

## Prevent accidental changes by using resource locks

- Resource lock prevents resources from being accidentally deleted or changed
- To manage locks, go to **Settings** then **Locks** pane.

![Pasted image 20230531080548](https://i.imgur.com/CRD7k95.png)

- in the portal, the locks are called **Delete** and **Read-only**
- in the command line, the locks are called **CanNotDelete**(can read and modify, but not delete) and **Read-only**(can read but not delete or update)

Locks apply even with RBAC - so even if you're the owner you must still remove the lock before you perform the blocked activity

### Combining locks with Azure Blueprints

- combine resource locks with Azure Blueprints to define a set of standard resources requires. 

- [x] NEXT: [Organize your Azure resources by using tags - Training | Microsoft Learn](https://learn.microsoft.com/en-us/training/modules/build-cloud-governance-strategy-azure/5-organize-resource-tags) (Unit 5 of 12) ✅ 2023-06-05

## Organising resources using tags

- used to organise resources as it provides extra information or metatada
- can be managed through PowerShell, Azure CLI, Azure Resource Manager templates, REST API and Azure portal
- Can also be managed using Azure policy
- There is no need to enforce that a specific tag is present on all resources (ie only mission critical servers have **Impact** tag and non tagged resources are considered non mission critical)

## Control and audit resources using Azure Policy

**Azure Policy** 
- enables creation, assignment and management of policies that control and audit resources. 
- evaluates resources and highlights resources that aren't compliant with policies created
- prevent non compliant resources from being created

> In some cases, Azure Policy can remediate non compliant resources and configurations to ensure the integrity of the state of the resources. (ie force resources of certain group to be tagged, reapply tag if it's missing)

**Initiatives** - groups of related policies

### Azure policy in action

1. Create a policy definition - definition looking what to evaluate and what action to take (ie prevent VMs from being deployed from certain regions, or audit storage accounts to verify they only accept connections from allowed networks)
2. Assign the definition to resources - policy assignment (scope base, ie scope can be management group, single subscription or a resource group). this is inherited by all child resources. You can exclude if needed
3. Review the evaluation results - when condition is evaluated, resource is marked as compliant or non-compliant. this happens once per hour.

(Kinda like a compliance policy in Intune)

### Azure Policy Initiatives

- way of grouping policies together
- multiple policy definitions acting toward a single goal (ie **Enable Monitoring in Azure Security Center** initiative contains over 100 separate policy definitions)

#### How to define an initiative 

- can be defined using Azure portal or command-line tools.

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/build-cloud-governance-strategy-azure/media/3-define-initiatives-a834dde7.png)

- Assignment is like assigning a policy definition,, it needs to be assigned to a specific scope of management group, subscription or resource group. 

## Azure Blueprints - govern multiple subscriptions

- define a repeatable set of governance tools and standard Azure resources
- typically used to govern multiple subscriptions 
- instead of using multiple Azure Policy per subscription, this can be done via Azure Blueprints 
- orchestrates the deployment of resource templates and artifacts like 
	- role assignments
	- policy assignments
	- azure resource manager templates
	- resource groups

### Azure Blueprints in action

1. create an Azure blueprint
2. Assign the blueprint
3. track the blueprint assignments

With Azure Blueprints, the relationship between the blueprint definition (what should be deployed) vs blueprint assignment (what was deployed) is preserved. It creates a record that associates the resources with the blueprint that defines it. 

Blueprints are versioned which allows tracking and commenting on changes on the blueprint

### Blueprints artifacts

- each component in the blueprint definition
- also possible for artifacts to not have additional parameters/configuration 
- can contain one or more parameters that can be configured


## [Cloud Adoption Framework for Azure](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/overview)

- provides proven guidance to help with cloud adoption journey
- consists of tools, documentation and proven practices

### Stages

1. Define strategy
2. make a plan
3. ready your organization
4. adopt the cloud
5. govern and manage your cloud environments

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/build-cloud-governance-strategy-azure/media/2-framework-stages-9b54ccbe.png)

## Create a subscription governance strategy

- Billing - create one billing report per subscription esp if you have multiple departments. resource tags can also help
- Access control - setup boundary for azure resources, consider if there's a need for separate subscriptions for development and for production 
- Subscription limits - setup resource limitations, this should be considered during design phase. 

- [x] Up Next: [Microsoft Cloud Adoption Framework for Azure - Training | Microsoft Learn](https://learn.microsoft.com/en-us/training/modules/microsoft-cloud-adoption-framework-for-azure/?WT.mc_id=cloudskillschallenge_71858d04-7069-436b-860c-a432f5bf3540) ✅ 2023-06-07

# Microsoft Cloud Adoption Framework for Azure

- collection of documentation, technical guidance, best practices and tools to help align business, org readiness and tech strategies

## Main stages
- plan
- ready
- adopt

![](https://learn.microsoft.com/en-us/training/wwl-mba/microsoft-cloud-adoption-framework-for-azure/media/ic-caf-2.jpg)

## Define Strategy

### What are the triggers?

- which triggers are relevant to the business? Opportunity to take advantage of benefits of cloud tech

### Strategy

- define clear business outcomes
- define business justification

Two-pronged approach:
- Business criteria - identify an application currently in operation that has strong motivation to move to cloud
- Technical criteria - select application that has the minimum dependencies and can be moved as small group of assets

### Business outcomes

- concise, defined, observable result or change in business performance captured by a specific measure
- strategy team should be of business leaders from Finance, IT infra and application groups so they can review business outcomes, create business justifications, facilitate cloud rationalization process, select first app and manage subsequent prioritized backlogs
- CFO can be a key player for the financial plan for adoption

**TOC Calculator**
- [Total Cost of Ownership (TCO) Calculator | Microsoft Azure](https://azure.microsoft.com/en-us/pricing/tco/calculator/)
- Gives you an estimate computation of how much it will cost to move over physical infrastructure to cloud (includes hardware, software, electricity, data center costs etc)

**Azure Pricing calculator**
- [Pricing Calculator | Microsoft Azure](https://azure.microsoft.com/en-us/pricing/calculator/)
- Cost estimates for azure agreements based on azure products

**Microsoft Cost Management + Billing**
- [Microsoft Cost Management | Microsoft Azure](https://azure.microsoft.com/en-us/products/cost-management/)
- per subscription
- cost management solution built in


### Business justification

- cost - how much will be saved from capital
- scale - can this scale elastically
- productivity - what can this remove / optimize
- reliability - data backup, DR, business continuity

Create a business case - proof of concept for cloud migration
- [Create a business case for cloud migration - Cloud Adoption Framework | Microsoft Learn](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/strategy/cloud-migration-business-case)


## Plan

### Rationalizing digital estate

- inventory all digital assets the organization owns then evaluate each asset to see which way to migrate or modernize to the cloud
- do this incrementally, application by application 
- dont make decisions too broadly or too early across the entire app portfolio

**Five Rs:**

1.  **Rehost (lift and shift)**:
    -   Quick migration to the cloud with minimal modifications.
    -   Replicates the existing application environment in the cloud.
    -   Limited optimization for cloud-native features and benefits.
2.  **Refactor (rearchitect)**:
    -   Modifies the application architecture or code to leverage cloud-native services and capabilities.
    -   Focuses on optimizing the application for scalability, performance, and cost-efficiency in the cloud.
    -   May involve breaking monolithic applications into microservices or adopting PaaS offerings.
3.  **Revise**:
    -   Significantly modifies the application's code or architecture while preserving core functionality.
    -   Provides flexibility to improve or optimize specific aspects of the application for the cloud environment.
    -   May require rewriting parts of the application or adopting new frameworks or technologies.
4.  **Rebuild**:
    -   Involves redeveloping the application from scratch using cloud-native technologies.
    -   Embraces cloud-native design principles, enabling maximum utilization of cloud advantages.
    -   Requires significant investment of time and resources but offers the highest level of cloud optimization.
5.  **Replace**:
    -   Replaces the existing application with a commercially available SaaS solution.
    -   Eliminates the need for application development or migration efforts.
    -   Requires adapting workflows and processes to align with the chosen SaaS solution.

## Ready

**Azure readiness guide** - helps organize resources, control cost and secure and manage the org

To prepare:
- define skills and support readiness
- create the landing zone

Landing zone - part of broader solution for organizing resources across a cloud environment

> The term _landing zone_ is used to describe an environment that's provisioned and prepared to host workloads in a cloud environment, such as Azure


- [x] Up next: [Adopt - Training | Microsoft Learn](https://learn.microsoft.com/en-us/training/modules/microsoft-cloud-adoption-framework-for-azure/6-adopt) ✅ 2023-06-08

## Adopt

**Cloud migration** - process of moving digital assets to a cloud platform
- prepare a rough migration backlog, business outcomes from Plan phase, digital estate estimate from Plan phase, roles and responsibilities from Ready phase, change management requirements from Ready phase.

- Documentation: https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/migrate/
- Migration model: https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/migrate/migration-considerations/
- Migration tool decision guide/flow chart: https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/migrate/azure-migration-guide/migration-tools-decision-guide
- blueprints sample - https://learn.microsoft.com/en-us/azure/governance/blueprints/samples/

**Cloud innovation** - even older apps can benefit from this by modernizing specific components or entire solution


## Govern and manage

**Cloud governance** - creates guardrails to keep org on a safe path through out the journey. the foundation for adoption and governance is called *minimum viable product (MVP)* which allows governance team to incorporate governance into implementations throughout the adoption lifecycle.

**cloud management** - maximize ongoing business returns by creating balance between stability and operational costs.

- Governance benchmark tool (questionnaire) - https://cafbaseline.com/

- [x] Up next: [Introduction to the Microsoft Azure Well-Architected Framework - Training | Microsoft Learn](https://learn.microsoft.com/en-us/training/modules/azure-well-architected-introduction/?WT.mc_id=cloudskillschallenge_71858d04-7069-436b-860c-a432f5bf3540) ✅ 2023-07-10

# Microsoft Azure Well-Architected Framework

![](https://learn.microsoft.com/en-us/training/modules/azure-well-architected-introduction/media/pillars.png)

## Cost optimization

Design the cloud environment so that it's cost effective. Ensure you're spending money where you can make great use of it.


![](https://learn.microsoft.com/en-us/training/modules/azure-well-architected-introduction/media/efficiency.png)


### Plan and estimate costs

- estimate costs by identifiying current resources to move or redevelop
- understand business objectives that may affect sizing
- selecting appropriate services needed for projects
- use cost-estimation tools to provide concise estimate of resources


### Provision with optimisation
- ensure appropriate service level is selected
- use discounts when available like reserved instances and BYOL (bring your own license) offers
- if possible, move from IaaS to PaaS. 

### Use monitoring and analytics to gain cost insights
- not monitoring your spending will not let you know what you can save
- take advantage of cost-management tools and review billing statements
- identify and track down cost anomalies that may show up on billing statements by using alerts

### Maximize efficiency of cloud spend


## Operational excellence

Automation. Take advantage of DevOps for faster development. Setup a good monitoring architecture to detect failures and problems before they even happen or before customer reports it. Automation is the key aspect in Operational excellence.

### Design, build and orchestrate with modern practices
- modern architectures should be designed with DevOps and continuous integration in mind. Modern architecture allows automating deployment by using Infrastructure as code, automate application testing and build new environments as needed
- Break down silos within organization ca be done using DevOps

### Use monitoring and analytics to gain operational insights
- have a thorough monitoring, logging and instrumentation system.
- Multilayered approach is essential - gather data points from every layer to help alert when values are outside acceptable ranges

### Automate and test
- Automate, automate, automate.
- Test application development and ongoing operations.

## Performance efficiency

![](https://learn.microsoft.com/en-us/training/modules/azure-well-architected-introduction/media/performance-demand.png)

- Matching an application's available resource within the demand it's receiving.
- Scale resources, identify and optimize potential bottlenecks and optimize application code for peak performance

### Scale up and scale out

**Scale up** - adding more resources such as CPU or memory to a single instance to a single instance or **vertical scaling**

**Scale out** - adding more instances like VM or PaaS services or **horizontal scaling**


![](https://i.imgur.com/AFVLBB0.png)


**Autoscaling** - process of dynamically allocating resources to match performance requirements. As demands slackens and added resources are no longer needed, they can be deallocated to minimize costs.

### Optimize network performance
- Adding a message layer between services can have benefits to performance and scalability

### Optimize storage performance
- Use caching in to store frequently used data or assets for faster retrieval
- Cache between users and web servers by placing static content close to users

## Reliability

Ensure there's a way to recover from any issue and environment is designed to anticipate failures at all levels. Systems should be able to recover from failure within the timeframe required/agreed.

- application should stay reliable and can handle both localized and broad-impact incidents
- use clustering and load balancing
	- clustering replaces a single VM with set of coordinated VMs
	- Load balancing spreads requests across many instances of a service, detects failed instances and prevents routing to them

### Architecture that can recover from failure

**Recovery point objective (RPO)** - maximum duration of acceptable data loss, limiting and recovering data loss not data theft

**Recovery time objective (RTO)** - maximum duration of acceptable downtime, ie if acceptable downtime duration is 8 hrs, then if there's a disaster, your RTO is 8hrs.

With RPO and RTO defined, you can design backup, restore, replication, and recovery capabilities into your architecture to meet these objectives.



## Security

![](https://learn.microsoft.com/en-us/training/modules/azure-well-architected-introduction/media/security.png)

Focus on security through authentication and protecting apps and data from network vulnerabilities, or using encryption.

Think about security through entire lifecycle, from design and implementation to deployment and operations. 

- [x] Up next: [Security - Training | Microsoft Learn](https://learn.microsoft.com/en-us/training/modules/azure-well-architected-introduction/7-security) ✅ 2023-07-11

Multilayered approach (defense in depth)

![](https://learn.microsoft.com/en-us/training/modules/azure-well-architected-introduction/media/security-layers.png)


> No single security system, control, or technology fully protects your architecture. Security is more than just technology; it's also about people and processes.



## General Design Principles

- No architecture is static. Allow for evolution of architecture by taking advantage of new services, tools and technologies when available
- Use data to make decisions by collecting and analysing it, making decisions surrounding the architecture. From cost data, to performance, user load, always use data.
- Educate and enable. As cloud technology evolves quickly, educate your development, operations and business teams to help them make right decisions and build solutions to solve business problems. Always document and share best practices within organizations.
- Automate. Always automate if possible. It minimizes errors from manual steps and provides consistency between environments

## Shared responsibility

![](https://learn.microsoft.com/en-us/training/modules/azure-well-architected-introduction/media/cloud-responsibility-model.png)


![](https://i.imgur.com/E3gKkaj.png)



# Secure access to applications by using Azure Identity Services

## Authentication (AuthN) and Authorization (AuthZ)

Authentication - establishing the identity of the person or service accessing the resource

Authorization - establishing the level of access an authenticated person or service has

# Azure compute services

Provides computing resources such as disks, processors, memory, networking and operating systems.

- Azure Virtual Machines
- Azure Container Instances
- Azure App Service
- Azure Functions (or _serverless computing_)

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-compute-fundamentals/media/compute-services-13e531e1.png)


VMs - software emulations of physical computers

Virtual machine scale sets - Deploy and manage a set of identical VMs. Designed for auto scale.

Containers and Kubernetes - Deploy and manage containers. Can run multiple instances of containerised application on single host machine.

App service - build, deploy and sclae enterprise-grade web, mobile and API apps. (PaaS offering)

Functions - great when concerned primarily with code running your service and not the platform or infrastructure. Often via REST request.

## When to use VM

- when you want full control over Operating system
- Run custom software
- Custom hosting config

Azure Batch - enables large-scale parallel and high performance computing (HPC) / ability to scale to tens to thousands VMs

## When to use Azure App Service

- pay for resources your app is using (based on requests)
- web apps, api apps, web jobs, mobile apps

## When to use Azure Container or Kubernetes services

- creating solutions using microservice architecture
- similar to [[docker]]

## When to use Azure Functions

- serverless computing
- abstraction of the servers / never explicitly reserve server instances
- event-driven scale triggered by timers, webhook scnearios, queues
- micro-billing - like paying for a monthly or annual rate for hosting with block of time


![](https://i.imgur.com/0qugWde.png)

## When to use Azure Virtual Desktop

- enables to use cloud hosted version of Windows from any location
- simplified management
- performance management
- multi session win10 deployment
- reduce cost using BYOL bring your own license

# Azure message queues

![](https://i.imgur.com/DrpnfCK.png)

## Service Bus queues

- needs to receive messages without having to poll the queue
- requires queue to provide FIFO ordered delivery
- needs to process messages as parallel long running streams using session ID
- needs transactional behavior when sending/receiving multiple messages from queue
- can exceed 64KB but not 256KB
- compliance with standards and protocols (ISO/IEC)

![](https://i.imgur.com/dMIdJMj.png)



## Storage queues

- need to store over 80GBs of messages
- track progress of messages
- require server side logging


- [x] Up next:[Discover Service Bus queues, topics, and subscriptions - Training | Microsoft Learn](https://learn.microsoft.com/en-us/training/modules/discover-azure-message-queue/4-queues-topics-subscriptions) ✅ 2023-07-19

## Queues

- Queues offer First In, First Out (FIFO) message delivery to one or more competing consumers
- Load-leveling - enables producers and consumers to send and receive messages at different rates

## Receive modes

- Service Bus receives messages in 2 modes: **Receive and delete** or **Peek lock**

### Receive and delete

- receives request from consumer, marks the message as consumed, returns it to consumer application
- works for scenarios wherein app can tolerate not processing a message if a failure occurs

### Peek lock

- for operations that cant tolerate missing messages

1. Finds message to be consumed, **locks** it so that other consumers will not receive it, then return the message to the app
2. After app is finished processing the message, it requests the Service Bus to complete the second state of the receive process then **marks the message as consumed**

- for any reason the app is unable top process, it can request the Service Bus service to **abandon** the message
- Service Bus then **unlocks** the message so its available again
- there's a **timeout** associated with the lock wherein if the app fails before the lock timeout expires, Service Bus unlocks the message to make it available again


### Topics and subscriptions

- in contrast to queues, topics and subscriptions provide a one-to-many form of communication in a publish or subscribe pattern
- useful for scaling to large numbers or recipients
- publishers send messages to a topic in the same way that they send message to a queue, but consumers wont receive messages directly from the topic, instead, receive messages from subscriptions of the topic.

### Rules and actions

- for specific reasons that must be processed in different ways. 
- configure subscriptions to find message with desired properties and perform certain modifications to those properties

#### A ChatGPT example of usage for Topics and subscriptions vs Rules and actions

Sure! Here are real-life scenario examples for the usage of Topics and Subscriptions, as well as Rules and Actions in Azure Message Queue:

1. Notification System:
    
    - Scenario: A company wants to build a notification system to send various types of notifications to its users, such as email notifications, SMS alerts, and push notifications.
    - Implementation: The company can use Azure Message Queue Topics and Subscriptions to handle different notification types. They can create a Topic called "Notifications" and create Subscriptions for each notification type, like "Emails," "SMS," and "Push Notifications." Subscribers can then subscribe to the relevant Subscriptions to receive the notifications they are interested in.
2. Event-driven Microservices:
    
    - Scenario: An e-commerce platform needs to implement an event-driven architecture using microservices, where different services react to specific events.
    - Implementation: Azure Message Queue Topics can be utilized to publish events, and Subscriptions can be created for each microservice interested in specific events. Each microservice can subscribe to relevant Subscriptions based on the events they need to handle. This allows for decoupled communication and enables efficient scaling and fault tolerance.

Now, let's look at the usage of Rules and Actions within Azure Message Queue:

3. Message Routing based on Content:
    
    - Scenario: A company receives messages from various sources and wants to route them to different queues or endpoints based on specific criteria within the message content.
    - Implementation: Azure Message Queue provides the ability to define Rules based on message properties or message content. For example, the company can define a Rule to check for a specific keyword in the message content, and if a match is found, it can perform an action to route the message to a particular queue or endpoint.
4. Dead-letter Queue Handling:
    
    - Scenario: When processing messages, it is crucial to handle any failed or undeliverable messages appropriately, to prevent data loss and ensure troubleshooting.
    - Implementation: Azure Message Queue allows the configuration of Rules to specify criteria for identifying problematic messages. For instance, a Rule can be defined to match messages that failed to process or exceeded a certain number of retries. When a message meets the Rule's conditions, an action can be triggered, such as moving the message to a dead-letter queue for further investigation and analysis.

These are just a few examples of how Topics, Subscriptions, Rules, and Actions in Azure Message Queue can be used in real-life scenarios to facilitate reliable and flexible messaging and event-driven systems.


## Service Bus message payloads and serialization

- A Service Bus message has three main sections: a binary payload, broker properties, and user properties.
- The binary payload is handled exclusively by the application and is not processed by the Service Bus service.
- The broker properties are predefined system properties that control message-level functionality within the broker or correspond to standardized metadata items.
	- A subset of the broker properties, specifically `To`, `ReplyTo`, `ReplyToSessionId`, `MessageId`, `CorrelationId`, and `SessionId`, help applications route messages to particular destination
		- Simple request/reply:
		    - Publisher sends a message to a queue and expects a reply from the consumer.
		    - Reply address is specified in the ReplyTo property of the outbound message.
		    - Consumer responds by copying MessageId to CorrelationId and delivering the reply to the specified ReplyTo address.
		- Multicast request/reply:
		    - Publisher sends a message to a topic with multiple subscribers.
		    - Each subscriber can respond individually.
		    - ReplyTo can point to a topic for distributing discovery responses to a wider audience.
		- Multiplexing:
		    - Sessions enable multiplexing of related messages through a single queue or subscription.
		    - Messages with matching SessionId values are routed to a specific receiver.
		    - The receiver holds the session under lock.
		- Multiplexed request/reply:
		    - Multiple publishers share a reply queue.
		    - ReplyToSessionId is used to instruct consumers to copy it to the SessionId of the reply message.
		    - The publishing queue or topic doesn't need to be session-aware.
		    - Publishers can wait for a session with the specified SessionId to materialize on the queue.
- The user properties are a collection of key-value pairs that are defined and set by the application itself.

# Azure Queue Storage

- service for storing large numbers of messages
- use HTTP or HTTPS
- 64KBin size
- up to millions of messages up to total limit of storage account
- for backlog of work to process asynchronously 

![](https://learn.microsoft.com/en-us/training/wwl-azure/discover-azure-message-queue/media/queue-storage-service-components.png)

- URL format: `https://<storage account>.queue.core.windows.net/<queue>` / example: `https://myaccount.queue.core.windows.net/images-to-download`
- Storage account: all access is done through storage account
- Queue: set of messages, all lowercase
- Message: any format up to 64KB. for 2017-07-29 or later versions, TTL can be a positive number or -1 indicating message doesnt expire. the default TTL is 7 days

- [x] Up next: [Explore Azure networking services - Training | Microsoft Learn](https://learn.microsoft.com/en-us/training/modules/azure-networking-fundamentals/) ✅ 2023-07-20

# Azure Virtual Network Fundamentals

## Azure virtual networking

Azure virtual networks enable Azure resources, such as VMs, web apps, and databases, to communicate with each other, with users on the internet, and with your on-premises client computers

### Isolation and segmentation

- Azure virtual network allows you to create multiple isolated virtual networks. When you setup a virtual network, you define a private IP address by using public or private IP ranges. 
- The public IP range only exists within the virtual network and isnt internet routable
- The IP address spaces can be divided into subnets 
- For name resolution, use the built in one, but you can configure a virtual network to use internal or external DNS server

### Internet communications

- by default, any Azure VM can connect to internet
- incoming connections from internet can be enabled by assigning a public IP address to the VM, or using public load balancer
- for VM management, Azure CLI, RDP or SSH can be used

### Communication between Azure resources

- **Virtual networks** - can connect not only VMs but other Azure resources as well
- **Service endpoints** - connect other Azure resource types (SQL dbs, storage accounts) as this approach lets you link multiple Azure resources to virtual networks

### Communication to on-premises resources

- **Point to site virtual private networks** - usual approach for VPN: connect from computer outside the org into the corporate network. this is through encrypted VPN connection
- **Site-to-site virtual private networks** - links on-prem VPN device or gateway to the Azure VPN gateway in a virtual network. The devices in Azure can appear as its on the local network. Encrypted connection, works over the internet
- **Azure Express Route** - For environments needing greater bandwidth and higher security, this is the best approach. ExpressRoute provides dedicated private connectivity to Azure that doesn't travel over the internet. 


![](https://i.imgur.com/K0nLEiW.png)


**Great resource:** https://k21academy.com/microsoft-azure/admin/recap-day-3-3/

## Route network traffic

- by defaut, Azure routes traffic between subnets on any connected virtual networks, on-premises networks and the internet
- **Route tables** - allow you to define rules about how traffic should be directed
- **Border Gateway Protocol** - BGP - works with Azure VPN gateways, Azure Route server or ExpressRoute to propagate on-premises BGP routes to Azure virtual networks

### Filter network traffic

- **[[Network security groups]]** - NSG - can contain multiple inbound and outbound security rules. Can block or allow traffic based on source, destination IP, port, protocol
- **Network virtual appliance** - specialized VM that can be compared to a hardened network appliance. for running firewall or performing WAN optimization

## Connect virtual networks

- use [[virtual peering]] to link virtual networks together

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-networking-fundamentals/media/local-or-remote-gateway-in-peered-virual-network-21106a38.png)


## Azure Virtual Network Settings

### Creating a virtual network

![](https://learn.microsoft.com/en-us/training/azure-fundamentals/azure-networking-fundamentals/media/create-virtual-network-ip-address-286df13c.png)

- **Address space** - This address space must be unique within your subscription and any other connected networks. For example, if you choose an address space of 10.0.0.0/24 for your first virtual network, it means that the valid addresses within this range are from 10.0.0.1 to 10.0.0.254.
- Now, let's say you create a second virtual network and select an address space of 10.0.0.0/8. In this case, the valid addresses within this range are from 10.0.0.1 to 10.255.255.254. However, since some of these addresses overlap with the first virtual network's address space, they cannot be used for both networks simultaneously.
- To resolve this issue, you can choose two non-overlapping address spaces: 10.0.0.0/16 and 10.1.0.0/16. The first address space allows for addresses ranging from 10.0.0.1 to 10.0.255.254, while the second address space allows for addresses ranging from 10.1.0.1 to 10.1.255.254. These address spaces can be assigned to your virtual networks because there is no overlap between them.
- You can create this after you create a virtual network


- **Subnet** - partitions the virtual network's address space. custom routes can be defined, or depend on the default traffic routes. or, define one subnet with all the virtual network's address ranges.
- name must begin with a letter or number and end with a letter, number or underscore. only letters, numbers, underscores, periods or hypens.


- **Service endpoints** - like Azure cosmos db, service bus, key vault etc

- **NAT Gateway** - can configure a subnet to use a static outbound IP address when accessing the internet ([[Azure NAT Gateway]])
- **BastionHost** - to enable [[Azure Bastion]] (seamless RDP/SSH over TLS)
- **[[DDoS Protection Standard]]** - enable or disable DDoS protection
- **[[Firewall]]** - enable or disable [[Azure Firewall]]

## Azure VPN Gateway Fundamentals

- [ ] Up next: https://learn.microsoft.com/en-us/training/modules/azure-networking-fundamentals/azure-vpn-gateway-fundamentals